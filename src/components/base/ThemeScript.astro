<script is:inline data-astro-rerun>
  const defaultTheme = "system";

  function getTheme(defaultTheme) {
    var darkMode = defaultTheme === "dark" ? true : false;
    if (localStorage.getItem("theme") === "system") {
      if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
        darkMode = true;
      }
    } else if (localStorage.getItem("theme") === "dark") {
      darkMode = true;
    } else if (localStorage.getItem("theme") === "light") {
      darkMode = false;
    }
    return darkMode;
  }

  function setTheme(darkMode) {
    // Update DOM
    darkMode
      ? document.documentElement.classList.add("dark")
      : document.documentElement.classList.remove("dark");
    // Update localStorage
    localStorage.setItem("theme", darkMode ? "dark" : "light");
    // Update checkbox state - QUESTA Ãˆ LA PARTE IMPORTANTE
    updateCheckboxState(darkMode);
  }

  function updateCheckboxState(darkMode) {
    var themeSwitchers = document.querySelectorAll("[data-theme-switcher]");
    themeSwitchers.forEach((switcher) => {
      switcher.checked = darkMode;
    });
  }

  // This prevents flickering back to default theme before the page is fully loaded
  setTheme(getTheme(defaultTheme));

  document.addEventListener("astro:page-load", () => {
    const currentTheme = getTheme(defaultTheme);
    setTheme(currentTheme);
    
    // Theme switcher
    var themeSwitch = document.querySelectorAll("[data-theme-switcher]");
    themeSwitch.forEach((el) => {
      el.addEventListener("change", (e) => {
        setTheme(e.target.checked);
      });
    });
  });

  // Ascolta i cambiamenti della preferenza di sistema
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (localStorage.getItem("theme") === "system") {
      const darkMode = e.matches;
      setTheme(darkMode);
    }
  });
</script>